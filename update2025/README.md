# Docker + GitHub Actions éƒ¨ç½²ä¸æ›´æ–°æŒ‡å— (å°ç™½ç‰ˆ)

æ¬¢è¿ä½¿ç”¨ï¼æœ¬æŒ‡å—å°†æ‰‹æŠŠæ‰‹æ•™æ‚¨å¦‚ä½•é€šè¿‡ **GitHub** å°†æ­¤é¡¹ç›®éƒ¨ç½²åˆ°ä¸€å°å…¨æ–°çš„äº¬ä¸œäº‘ **Ubuntu 22.04** æœåŠ¡å™¨ä¸Šï¼Œå¹¶æŒ‡å¯¼æ‚¨å¦‚ä½•è¿›è¡Œåç»­çš„**è‡ªåŠ¨åŒ–æ›´æ–°**ã€‚

---

## ç›®å½•

1.  [**æœ¬åœ°å‡†å¤‡ä¸ä¸Šä¼  GitHub**](#æœ¬åœ°å‡†å¤‡ä¸ä¸Šä¼ -github)
    *   [æ­¥éª¤ 1ï¼šåœ¨æœ¬åœ°åˆå§‹åŒ– Git ä»“åº“](#æ­¥éª¤-1åœ¨æœ¬åœ°åˆå§‹åŒ–-git-ä»“åº“)
    *   [æ­¥éª¤ 2ï¼šåœ¨ GitHub åˆ›å»ºæ–°ä»“åº“å¹¶ä¸Šä¼ ä»£ç ](#æ­¥éª¤-2åœ¨-github-åˆ›å»ºæ–°ä»“åº“å¹¶ä¸Šä¼ ä»£ç )
2.  [**é¦–æ¬¡æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—**](#é¦–æ¬¡æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—)
    *   [æ­¥éª¤ 3ï¼šè¿æ¥åˆ°æ‚¨çš„äº‘æœåŠ¡å™¨å¹¶å‡†å¤‡ç¯å¢ƒ](#æ­¥éª¤-3è¿æ¥åˆ°æ‚¨çš„äº‘æœåŠ¡å™¨å¹¶å‡†å¤‡ç¯å¢ƒ)
    *   [æ­¥éª¤ 4ï¼šä» GitHub å…‹éš†é¡¹ç›®åˆ°æœåŠ¡å™¨](#æ­¥éª¤-4ä»-github-å…‹éš†é¡¹ç›®åˆ°æœåŠ¡å™¨)
    *   [æ­¥éª¤ 5ï¼šæ„å»ºå¹¶å¯åŠ¨æ‚¨çš„åº”ç”¨](#æ­¥éª¤-5æ„å»ºå¹¶å¯åŠ¨æ‚¨çš„åº”ç”¨)
    *   [æ­¥éª¤ 6ï¼š(æ¨è) é…ç½® Nginx åå‘ä»£ç†ä¸ HTTPS](#æ­¥éª¤-6æ¨è-é…ç½®-nginx-åå‘ä»£ç†ä¸-https)
3.  [**åç»­æ›´æ–°æŒ‡å— (æ–°æµç¨‹ï¼)**](#åç»­æ›´æ–°æŒ‡å—-æ–°æµç¨‹)

---

## æœ¬åœ°å‡†å¤‡ä¸ä¸Šä¼  GitHub

### æ­¥éª¤ 1ï¼šåœ¨æœ¬åœ°åˆå§‹åŒ– Git ä»“åº“

åœ¨æ‚¨æœ¬åœ°çš„é¡¹ç›®æ ¹ç›®å½•ï¼ˆ`zhjh/`ï¼‰ä¸‹ï¼Œæ‰“å¼€ç»ˆç«¯å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. åˆå§‹åŒ– Git ä»“åº“
git init -b main

# 2. å°†æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
git add .

# 3. åˆ›å»ºç¬¬ä¸€æ¬¡æäº¤
git commit -m "feat: initial project setup for deployment"
```

### æ­¥éª¤ 2ï¼šåœ¨ GitHub åˆ›å»ºæ–°ä»“åº“å¹¶ä¸Šä¼ ä»£ç 

1.  **è®¿é—® GitHub** (https://github.com) å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„**ç§æœ‰** (Private) ä»“åº“ï¼Œ**ä¸è¦**å‹¾é€‰ä»»ä½• "Initialize this repository with" çš„é€‰é¡¹ã€‚
2.  åˆ›å»ºåï¼Œå¤åˆ¶é¡µé¢ä¸Š "â€¦or push an existing repository from the command line" ä¸‹æ–¹çš„ä¸¤è¡Œå‘½ä»¤ï¼Œå¹¶åœ¨æ‚¨çš„æœ¬åœ°é¡¹ç›®ç»ˆç«¯ä¸­æ‰§è¡Œã€‚å®ƒä»¬çœ‹èµ·æ¥åƒè¿™æ ·ï¼š
    ```bash
    # å°†ä¸‹é¢çš„ URL æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ä»“åº“ URL
    git remote add origin https://github.com/your-username/your-repo-name.git
    git push -u origin main
    ```

å®Œæˆåï¼Œæ‚¨çš„ä»£ç å°±æˆåŠŸä¸Šä¼ åˆ° GitHub äº†ï¼

---

## é¦–æ¬¡æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

### æ­¥éª¤ 3ï¼šè¿æ¥åˆ°æ‚¨çš„äº‘æœåŠ¡å™¨å¹¶å‡†å¤‡ç¯å¢ƒ

1.  **è¿æ¥æœåŠ¡å™¨**ï¼š
    ```bash
    ssh ç”¨æˆ·å@æœåŠ¡å™¨å…¬ç½‘IPåœ°å€
    ```

2.  **ä¸€é”®å®‰è£… Git, Docker å’Œ Docker Compose**ï¼š
    ```bash
    # 1. æ›´æ–°ç³»ç»ŸåŒ…åˆ—è¡¨
    sudo apt-get update -y
    
    # 2. å®‰è£… Git å’Œå…¶ä»–åŸºç¡€å·¥å…·
    sudo apt-get install -y git apt-transport-https ca-certificates curl software-properties-common

    # 3. å®‰è£… Docker (åç»­æ­¥éª¤ä¸ä¹‹å‰ç›¸åŒ)
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    sudo apt-get update -y
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io

    # 4. å®‰è£… Docker Compose (å®˜æ–¹æ¨èæ–¹å¼)
    # é€šè¿‡ apt ç›´æ¥å®‰è£… Docker Compose æ’ä»¶ï¼Œè¿™æ˜¯æœ€ç¨³å®šå¯é çš„æ–¹æ³•
    sudo apt-get install -y docker-compose-plugin

    # 5. éªŒè¯å®‰è£…
    # æ³¨æ„ï¼šæ’ä»¶ç‰ˆçš„éªŒè¯å‘½ä»¤æ²¡æœ‰ä¸­é—´çš„è¿å­—ç¬¦ "-"
    git --version && docker --version && docker compose version
    ```
    çœ‹åˆ°ä¸‰ä¸ªå·¥å…·çš„ç‰ˆæœ¬å·å³è¡¨ç¤ºæˆåŠŸã€‚

### æ­¥éª¤ 3.5: (å…³é”®) é…ç½® Docker å›½å†…é•œåƒåŠ é€Ÿ

è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒèƒ½è§£å†³ä»å›½å¤– Docker Hub æ‹‰å–é•œåƒè¶…æ—¶å¤±è´¥çš„é—®é¢˜ã€‚

1.  **åˆ›å»ºæˆ–è¦†ç›– Docker é…ç½®æ–‡ä»¶ï¼Œå†™å…¥å›½å†…é•œåƒåœ°å€**ï¼š
    ```bash
    sudo mkdir -p /etc/docker
    sudo tee /etc/docker/daemon.json <<-'EOF'
    {
      "registry-mirrors": ["https://docker.m.daocloud.io"]
    }
    EOF
    ```

2.  **é‡å¯ Docker æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ**ï¼š
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl restart docker
    ```

### æ­¥éª¤ 4ï¼šä» GitHub å…‹éš†é¡¹ç›® (æœ€ç»ˆæ–¹æ¡ˆï¼šä½¿ç”¨ SSH)

ä¸ºäº†å½»åº•è§£å†³å›½å†…æœåŠ¡å™¨è¿æ¥ GitHub ä¸ç¨³å®šçš„é—®é¢˜ï¼Œæˆ‘ä»¬å°†**åªä½¿ç”¨ SSH åè®®**è¿›è¡Œå…‹éš†å’Œæ›´æ–°ã€‚è¿™æ˜¯æœ€ç¨³å®šå¯é çš„æ–¹å¼ã€‚

1.  **åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆ SSH å¯†é’¥**ï¼š
    ```bash
    # å°†å¼•å·å†…çš„é‚®ç®±æ¢æˆæ‚¨è‡ªå·±çš„
    ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
    ```
    (æ¥ä¸‹æ¥ä¼šæç¤ºæ‚¨è¾“å…¥æ–‡ä»¶åå’Œå¯†ç ï¼Œ**ä¸€è·¯æŒ‰ Enter é”®**ä½¿ç”¨é»˜è®¤è®¾ç½®å³å¯ï¼Œä¸è¦è¾“å…¥å¯†ç ã€‚)

2.  **æŸ¥çœ‹å¹¶å¤åˆ¶æ‚¨çš„å…¬é’¥**ï¼š
    ```bash
    cat ~/.ssh/id_rsa.pub
    ```
    (è¯·å®Œæ•´å¤åˆ¶å±å¹•ä¸Šè¾“å‡ºçš„ `ssh-rsa` å¼€å¤´çš„æ‰€æœ‰å†…å®¹)

3.  **åœ¨ GitHub ä¸Šæ·»åŠ "éƒ¨ç½²å¯†é’¥"(Deploy Key)**ï¼š
    *   è¿›å…¥æ‚¨åœ¨ GitHub ä¸Šçš„ `njczy/zhjh` ä»“åº“ä¸»é¡µã€‚
    *   ç‚¹å‡» `Settings` -> `Security` -> `Deploy keys`ã€‚
    *   ç‚¹å‡» `Add deploy key` æŒ‰é’®ã€‚
    *   `Title` å¯ä»¥éšä¾¿å¡«å†™ï¼Œä¾‹å¦‚ `my-jd-cloud-server`ã€‚
    *   å°†åˆšåˆšå¤åˆ¶çš„å…¬é’¥å®Œæ•´åœ°ç²˜è´´åˆ° `Key` æ–‡æœ¬æ¡†ä¸­ã€‚
    *   **å‹¾é€‰ `Allow write access`**ã€‚è™½ç„¶æˆ‘ä»¬ä¸»è¦æ˜¯æ‹‰å–ï¼Œä½†åœ¨æŸäº› git æ“ä½œä¸­è¿™èƒ½é¿å…ä¸€äº›æ½œåœ¨çš„æƒé™é—®é¢˜ã€‚
    *   ç‚¹å‡» `Add key`ã€‚

4.  **ä½¿ç”¨ SSH åœ°å€å…‹éš†æ‚¨çš„é¡¹ç›®**ï¼š
    ```bash
    # åœ¨ GitHub ä»“åº“é¡µé¢ï¼Œç‚¹å‡» "Code"ï¼Œç¡®ä¿åˆ‡æ¢åˆ° "SSH" é€‰é¡¹å¡ï¼Œç„¶åå¤åˆ¶ URL
    git clone git@github.com:njczy/zhjh.git

    # è¿›å…¥é¡¹ç›®ç›®å½•
    cd /zhjh/
    ```

### æ­¥éª¤ 5ï¼šæ„å»ºå¹¶å¯åŠ¨æ‚¨çš„åº”ç”¨

åœ¨æœåŠ¡å™¨çš„é¡¹ç›®ç›®å½•ä¸­ï¼Œåªéœ€è¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼š
```bash
# æ³¨æ„ï¼šæ–°ç‰ˆå‘½ä»¤æ˜¯ "docker compose"ï¼ˆä¸­é—´æ˜¯ç©ºæ ¼ï¼‰
sudo docker compose up --build -d
```
Docker ä¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰å·¥ä½œã€‚

### æ­¥éª¤ 6ï¼š(æ¨è) é…ç½® Nginx åå‘ä»£ç†ä¸ HTTPS

è¿™ä¸€æ­¥ä¸ä¹‹å‰çš„æŒ‡å—å®Œå…¨ç›¸åŒï¼Œæ‚¨å¯ä»¥ç›´æ¥å‚è€ƒã€‚é…ç½®æ—¶ï¼Œè¯·ç¡®ä¿ä½¿ç”¨çš„æ˜¯å…‹éš†ä¸‹æ¥çš„æ–°é¡¹ç›®ç›®å½•ä¸­çš„ `update2025/nginx.conf` æ–‡ä»¶ã€‚

---

## åç»­æ›´æ–°æŒ‡å— (æ–°æµç¨‹ï¼)

ç°åœ¨ï¼Œæ›´æ–°æµç¨‹å˜å¾—å‰æ‰€æœªæœ‰çš„ç®€å•ï¼š

1.  **æœ¬åœ°å¼€å‘**ï¼šåœ¨æ‚¨çš„ç”µè„‘ä¸Šä¿®æ”¹ä»£ç ã€‚
2.  **æäº¤å¹¶æ¨é€**ï¼šå°†ä»£ç æ”¹åŠ¨æ¨é€åˆ° GitHubã€‚
    ```bash
    git add .
    git commit -m "feat: æ·»åŠ äº†æ–°åŠŸèƒ½" # æˆ–è€…å…¶ä»–æè¿°æ€§ä¿¡æ¯
    git push origin main
    ```
3.  **ç™»å½•æœåŠ¡å™¨å¹¶æ‰§è¡Œä¸€é”®æ›´æ–°**ï¼š
    ```bash
    ssh ç”¨æˆ·å@æœåŠ¡å™¨å…¬ç½‘IPåœ°å€
    cd /zhjh/  # è¿›å…¥é¡¹ç›®ç›®å½•

    # é¦–æ¬¡æ‹‰å–ä»£ç åï¼Œéœ€è¦ç»™æ›´æ–°è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆæ­¤å‘½ä»¤åªéœ€è¿è¡Œä¸€æ¬¡ï¼‰
    chmod +x update2025/update.sh

    # ä¹‹åï¼Œæ¯æ¬¡æ›´æ–°éƒ½åªéœ€è¿è¡Œæ­¤è„šæœ¬
    ./update2025/update.sh
    ```

è„šæœ¬ä¼šè‡ªåŠ¨ä» GitHub æ‹‰å–æœ€æ–°çš„ä»£ç ï¼Œç„¶åé‡å»º Docker é•œåƒå¹¶é‡å¯æœåŠ¡ï¼Œå…¨ç¨‹æ— éœ€æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶ã€‚

# é¡¹ç›®éƒ¨ç½²æ›´æ–°è¯´æ˜

## ğŸš€ 2025å¹´1æœˆæ›´æ–°

### é¡¹ç›®æ¦‚è¿°
æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Next.js 15 çš„é¡¹ç›®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¾…åŠäº‹é¡¹ç®¡ç†ã€é¡¹ç›®å‚¨å¤‡ç®¡ç†ç­‰åŠŸèƒ½ã€‚

### å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

#### Windows å¼€å‘ç¯å¢ƒ
ç”±äº Windows ç¯å¢ƒä¸‹çš„ç¬¦å·é“¾æ¥æƒé™é™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå¼€å‘ï¼š

```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨ï¼ˆæ¨èï¼‰
npm run dev:win

# å¼€å‘ç¯å¢ƒæ„å»ºï¼ˆä¸ä½¿ç”¨ standaloneï¼‰
npm run build:win
```

#### Linux ç”Ÿäº§ç¯å¢ƒï¼ˆDockerï¼‰
ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ standalone è¾“å‡ºæ¨¡å¼ï¼Œé€‚åˆå®¹å™¨åŒ–éƒ¨ç½²ï¼š

```bash
# æ ‡å‡†æ„å»ºï¼ˆåŒ…å« standalone è¾“å‡ºï¼‰
npm run build

# Docker ä¸“ç”¨æ„å»º
npm run build:docker
```

### ğŸ³ Docker éƒ¨ç½²

#### 1. æ„å»ºé•œåƒ
```bash
docker build -t zhjh-app .
```

#### 2. ä½¿ç”¨ Docker Compose å¯åŠ¨
```bash
docker-compose up -d
```

#### 3. è®¿é—®åº”ç”¨
- æœ¬åœ°è®¿é—®ï¼šhttp://localhost
- æœåŠ¡å™¨è®¿é—®ï¼šhttp://your-server-ip

### ğŸ“ é¡¹ç›®ç»“æ„è¯´æ˜

```
zhjh/
â”œâ”€â”€ app/                    # Next.js 13+ App Router
â”‚   â”œâ”€â”€ api/               # API è·¯ç”±
â”‚   â”œâ”€â”€ todo/              # å¾…åŠé¡µé¢
â”‚   â”œâ”€â”€ reserve-projects/  # å‚¨å¤‡é¡¹ç›®é¡µé¢
â”‚   â””â”€â”€ monthly-reviews/   # æœˆåº¦å®¡æ ¸é¡µé¢
â”œâ”€â”€ components/            # React ç»„ä»¶
â”œâ”€â”€ lib/                   # å·¥å…·å‡½æ•°
â”œâ”€â”€ data/                  # æ•°æ®æ–‡ä»¶
â”œâ”€â”€ public/                # é™æ€èµ„æº
â”œâ”€â”€ Dockerfile             # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml     # Docker Compose é…ç½®
â”œâ”€â”€ next.config.mjs        # Next.js ç”Ÿäº§é…ç½®
â”œâ”€â”€ next.config.dev.mjs    # Next.js å¼€å‘é…ç½®ï¼ˆWindows å…¼å®¹ï¼‰
â””â”€â”€ update2025/           # éƒ¨ç½²è„šæœ¬å’Œé…ç½®
```

### âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

#### next.config.mjsï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- å¯ç”¨ `output: 'standalone'` ç”¨äº Docker éƒ¨ç½²
- ä¼˜åŒ–åŒ…å¯¼å…¥å’Œæ„å»ºæ€§èƒ½
- é…ç½® ESLint å’Œ TypeScript å¿½ç•¥è§„åˆ™

#### next.config.dev.mjsï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- ç¦ç”¨ `output: 'standalone'` é¿å… Windows ç¬¦å·é“¾æ¥é—®é¢˜
- æ·»åŠ  webpack ç›‘å¬é…ç½®
- ä¼˜åŒ–å¼€å‘ä½“éªŒ

### ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

#### Windows ç¬¦å·é“¾æ¥æƒé™é—®é¢˜
å¦‚æœåœ¨ Windows ç¯å¢ƒä¸‹é‡åˆ° `EPERM: operation not permitted, symlink` é”™è¯¯ï¼š

1. **ä½¿ç”¨å¼€å‘é…ç½®**ï¼š
   ```bash
   npm run dev:win
   npm run build:win
   ```

2. **ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ**ï¼š
   - å³é”®ç‚¹å‡» PowerShell æˆ– CMD
   - é€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
   - é‡æ–°æ‰§è¡Œæ„å»ºå‘½ä»¤

3. **å¯ç”¨å¼€å‘è€…æ¨¡å¼**ï¼š
   - æ‰“å¼€ Windows è®¾ç½®
   - è½¬åˆ°"æ›´æ–°å’Œå®‰å…¨" > "å¼€å‘è€…é€‰é¡¹"
   - å¯ç”¨"å¼€å‘è€…æ¨¡å¼"

#### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. **äº¬ä¸œäº‘æœåŠ¡å™¨éƒ¨ç½²**ï¼š
   ```bash
   # å…‹éš†ä»£ç 
   git clone <repository-url>
   cd zhjh
   
   # æ„å»ºå’Œå¯åŠ¨
   docker-compose up -d
   ```

2. **Nginx é…ç½®**ï¼š
   ä½¿ç”¨ `update2025/nginx.conf` é…ç½®åå‘ä»£ç†

3. **æ›´æ–°è„šæœ¬**ï¼š
   ä½¿ç”¨ `update2025/update.sh` è¿›è¡Œè‡ªåŠ¨åŒ–æ›´æ–°

### ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.env.localï¼‰
- [ ] æ•°æ®æ–‡ä»¶æƒé™è®¾ç½®
- [ ] Docker å’Œ Docker Compose å®‰è£…
- [ ] é˜²ç«å¢™ç«¯å£å¼€æ”¾ï¼ˆ80, 443ï¼‰
- [ ] SSL è¯ä¹¦é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] å¤‡ä»½ç­–ç•¥è®¾ç½®

### ğŸ”„ æ›´æ–°æµç¨‹

1. **å¼€å‘ç¯å¢ƒæµ‹è¯•**ï¼š
   ```bash
   npm run dev:win
   ```

2. **æ„å»ºéªŒè¯**ï¼š
   ```bash
   npm run build:win  # Windows æœ¬åœ°éªŒè¯
   npm run build      # ç”Ÿäº§æ„å»ºéªŒè¯
   ```

3. **éƒ¨ç½²åˆ°ç”Ÿäº§**ï¼š
   ```bash
   git push origin main
   # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ update.sh
   ```

### ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Node.js ç‰ˆæœ¬ï¼ˆæ¨è 20.xï¼‰
2. pnpm ç‰ˆæœ¬å’Œç¼“å­˜
3. Docker ç¯å¢ƒé…ç½®
4. ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

## ğŸš€ æ–°å¢æ›´æ–°è„šæœ¬è¯´æ˜

### update.sh - å®Œæ•´æ›´æ–°è„šæœ¬
- è‡ªåŠ¨æ£€æµ‹ Git åè®®ï¼ˆSSH/HTTPSï¼‰
- æ™ºèƒ½ç½‘ç»œè¿æ¥æ£€æµ‹å’Œå¤‡ç”¨æ–¹æ¡ˆ
- å®Œæ•´çš„ Docker æ„å»ºå’Œéƒ¨ç½²æµç¨‹
- é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥

### quick-update.sh - å¿«é€Ÿæ›´æ–°è„šæœ¬
- ç®€åŒ–çš„æ›´æ–°æµç¨‹ï¼Œé€‚åˆæ—¥å¸¸å¼€å‘
- å¿«é€Ÿæ‹‰å–ä»£ç å¹¶é‡æ–°éƒ¨ç½²
- æœ€å°åŒ–åœæœºæ—¶é—´

### ä½¿ç”¨å»ºè®®

**é¦–æ¬¡éƒ¨ç½²æˆ–é‡å¤§æ›´æ–°**ï¼š
```bash
./update2025/update.sh
```

**æ—¥å¸¸å¼€å‘æ›´æ–°**ï¼š
```bash
./update2025/quick-update.sh
```

**æ‰‹åŠ¨æ§åˆ¶**ï¼š
```bash
# ä»…æ‹‰å–ä»£ç 
git pull origin main

# ä»…é‡æ–°éƒ¨ç½²
docker-compose up -d --build
```

---

**æœ€åæ›´æ–°**ï¼š2025å¹´1æœˆ
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å¼€å‘å›¢é˜Ÿ 

# é¡¹ç›®æ›´æ–°éƒ¨ç½²è¯´æ˜

## ğŸ“‹ ç›®å½•
- [å¿«é€Ÿæ›´æ–°](#å¿«é€Ÿæ›´æ–°)
- [æ„å»ºé—®é¢˜è§£å†³](#æ„å»ºé—®é¢˜è§£å†³)
- [è¯¦ç»†éƒ¨ç½²æµç¨‹](#è¯¦ç»†éƒ¨ç½²æµç¨‹)
- [ç½‘ç»œé…ç½®](#ç½‘ç»œé…ç½®)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸš€ å¿«é€Ÿæ›´æ–°

### æ ‡å‡†æ›´æ–°ï¼ˆæ¨èï¼‰
```bash
# æ ‡å‡†æ›´æ–°æµç¨‹
sudo bash ./update2025/update.sh
```

### ä¼˜åŒ–æ›´æ–°ï¼ˆè§£å†³æ„å»ºå¡é¡¿ï¼‰
```bash
# è§£å†³æ„å»ºå¡åœ¨ "Generating static pages" çš„é—®é¢˜
sudo bash ./update2025/quick-update-optimized.sh
```

## ğŸ”§ æ„å»ºé—®é¢˜è§£å†³

### é—®é¢˜ï¼šæ„å»ºå¡åœ¨ "Generating static pages"

**ç—‡çŠ¶:**
- æ„å»ºè¿›åº¦åœåœ¨ "Generating static pages (0/22)" 
- é•¿æ—¶é—´æ— å“åº”ï¼ˆè¶…è¿‡ 15 åˆ†é’Ÿï¼‰
- å†…å­˜å ç”¨è¿‡é«˜

**æ ¹æœ¬åŸå› :**
1. **å¤§é‡é™æ€é¡µé¢**: é¡¹ç›®åŒ…å«å¤šä¸ªå¤æ‚é¡µé¢éœ€è¦é¢„æ¸²æŸ“
2. **æœåŠ¡ç«¯æ•°æ®åŠ è½½**: æ„å»ºæ—¶è¯»å– data/ ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶
3. **å†…å­˜ä¸è¶³**: é»˜è®¤ Node.js å†…å­˜é™åˆ¶ä¸å¤Ÿ
4. **ä¾èµ–å¤æ‚**: å¤§é‡ UI ç»„ä»¶åº“ä¾èµ–

**è§£å†³æ–¹æ¡ˆ:**

#### æ–¹æ¡ˆ 1: ä½¿ç”¨ä¼˜åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# è¿è¡Œæ„å»ºé—®é¢˜ä¿®å¤è„šæœ¬
sudo bash ./update2025/fix-build-issues.sh

# ç„¶åä½¿ç”¨ä¼˜åŒ–æ›´æ–°
sudo bash ./update2025/quick-update-optimized.sh
```

#### æ–¹æ¡ˆ 2: æ‰‹åŠ¨ä¼˜åŒ–
```bash
# 1. æ¸…ç†ç¼“å­˜
rm -rf .next node_modules/.cache
sudo docker builder prune -f

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_OPTIONS="--max-old-space-size=6144"
export NEXT_TELEMETRY_DISABLED=1

# 3. ä½¿ç”¨ä¼˜åŒ–é…ç½®æ„å»º
cp next.config.build.mjs next.config.mjs
npm run build
```

#### æ–¹æ¡ˆ 3: åˆ†æ­¥æ„å»º
```bash
# 1. å…ˆæ„å»ºä¾èµ–
npm ci --only=production

# 2. å¢åŠ  swapï¼ˆå¦‚æœå†…å­˜ä¸è¶³ï¼‰
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 3. ç›‘æ§æ„å»ºè¿‡ç¨‹
./update2025/monitor-build.sh &

# 4. æ‰§è¡Œæ„å»º
timeout 1800 npm run build
```

### æ„å»ºä¼˜åŒ–é…ç½®è¯´æ˜

**å†…å­˜ä¼˜åŒ–:**
- å¢åŠ  Node.js å †å†…å­˜: `--max-old-space-size=6144`
- å¢åŠ åŠç©ºé—´å†…å­˜: `--max-semi-space-size=512`
- å¯ç”¨ç³»ç»Ÿ swap ç©ºé—´

**æ„å»ºä¼˜åŒ–:**
- è·³è¿‡ TypeScript ç±»å‹æ£€æŸ¥
- è·³è¿‡ ESLint æ£€æŸ¥
- ç¦ç”¨é¥æµ‹æ•°æ®æ”¶é›†
- ä¼˜åŒ–åŒ…åˆ†å‰²ç­–ç•¥

**Docker ä¼˜åŒ–:**
- å¯ç”¨ BuildKit å¹¶è¡Œæ„å»º
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
- ä¼˜åŒ–é•œåƒå±‚ç¼“å­˜

## ğŸ“Š ç›‘æ§å·¥å…·

### æ„å»ºè¿‡ç¨‹ç›‘æ§
```bash
# å¯åŠ¨ç›‘æ§ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰
./update2025/monitor-build.sh
```

### ç³»ç»Ÿèµ„æºæ£€æŸ¥
```bash
# æ£€æŸ¥å†…å­˜
free -h

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ Docker çŠ¶æ€
sudo docker system df
```

## âš¡ æ€§èƒ½è°ƒä¼˜å»ºè®®

### æœåŠ¡å™¨é…ç½®å»ºè®®
- **å†…å­˜**: æœ€å°‘ 8GBï¼Œæ¨è 16GB+
- **CPU**: æœ€å°‘ 4 æ ¸ï¼Œæ¨è 8 æ ¸+
- **ç£ç›˜**: æœ€å°‘ 20GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„ç½‘ç»œè¿æ¥

### æ„å»ºæ—¶é—´é¢„æœŸ
- **é¦–æ¬¡æ„å»º**: 15-30 åˆ†é’Ÿ
- **å¢é‡æ„å»º**: 8-15 åˆ†é’Ÿ
- **ç¼“å­˜æ„å»º**: 3-8 åˆ†é’Ÿ

### æ„å»ºé˜¶æ®µè¯´æ˜
1. **ä¾èµ–å®‰è£…** (2-5 åˆ†é’Ÿ): ä¸‹è½½ npm åŒ…
2. **TypeScript ç¼–è¯‘** (3-8 åˆ†é’Ÿ): ç¼–è¯‘ TS ä»£ç 
3. **é™æ€é¡µé¢ç”Ÿæˆ** (5-15 åˆ†é’Ÿ): é¢„æ¸²æŸ“é¡µé¢ âš ï¸ æœ€å®¹æ˜“å¡ä½çš„é˜¶æ®µ
4. **èµ„æºä¼˜åŒ–** (1-3 åˆ†é’Ÿ): å‹ç¼©å’Œä¼˜åŒ–
5. **Docker æ‰“åŒ…** (2-5 åˆ†é’Ÿ): åˆ›å»ºå®¹å™¨é•œåƒ

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

#### 1. æ„å»ºè¶…æ—¶
```bash
# ç—‡çŠ¶: æ„å»ºè¶…è¿‡ 30 åˆ†é’Ÿ
# è§£å†³: å¢åŠ è¶…æ—¶æ—¶é—´å’Œå†…å­˜
export NODE_OPTIONS="--max-old-space-size=8192"
timeout 3600 npm run build  # 1 å°æ—¶è¶…æ—¶
```

#### 2. å†…å­˜ä¸è¶³
```bash
# ç—‡çŠ¶: JavaScript heap out of memory
# è§£å†³: å¢åŠ è™šæ‹Ÿå†…å­˜
sudo dd if=/dev/zero of=/swapfile bs=1G count=8
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 3. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æ¸…ç† Docker èµ„æº
sudo docker system prune -af
sudo docker volume prune -f

# æ¸…ç† npm ç¼“å­˜
npm cache clean --force
```

#### 4. ç½‘ç»œè¿æ¥é—®é¢˜
```bash
# ä½¿ç”¨å›½å†…é•œåƒ
npm config set registry https://registry.npmmirror.com
```

#### 5. æƒé™é—®é¢˜
```bash
# ä¿®å¤ Docker æƒé™
sudo usermod -aG docker $USER
newgrp docker
```

### æ—¥å¿—åˆ†æ

#### æŸ¥çœ‹æ„å»ºæ—¥å¿—
```bash
# Docker æ„å»ºæ—¥å¿—
sudo docker logs $(sudo docker ps -aq | head -1)

# ç³»ç»Ÿæ—¥å¿—
journalctl -u docker -f
```

#### æ„å»ºè¿›åº¦è¿½è¸ª
```bash
# å®æ—¶ç›‘æ§æ„å»ºè¾“å‡º
tail -f /var/log/docker.log | grep -E "(Step|RUN|COPY|Generating)"
```

## ğŸ”„ å›æ»šæœºåˆ¶

### å¿«é€Ÿå›æ»š
```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
sudo docker tag zhjh-app:latest zhjh-app:rollback
sudo docker-compose down
sudo docker-compose up -d
```

### ä¿å­˜å½“å‰ç‰ˆæœ¬
```bash
# æ„å»ºå‰å¤‡ä»½
sudo docker tag zhjh-app:latest zhjh-app:backup-$(date +%Y%m%d-%H%M%S)
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°æ„å»ºé—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. é”™è¯¯æ—¥å¿—
2. ç³»ç»Ÿé…ç½® (`free -h`, `df -h`)
3. Docker ç‰ˆæœ¬ (`docker --version`)
4. Node.js ç‰ˆæœ¬ (`node --version`)

**è”ç³»æ–¹å¼:**
- æŸ¥çœ‹æ—¥å¿—: `sudo docker-compose logs app`
- ç³»ç»ŸçŠ¶æ€: `sudo docker-compose ps`
- é‡å¯æœåŠ¡: `sudo docker-compose restart app` 